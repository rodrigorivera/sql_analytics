SELECT
r.productsku AS productsku,

			SUM(r.sbr) AS sold_products_bef_return,
			SUM(r.sar) AS sold_products_aft_return,
			CASE 
				WHEN SUM(r.sbr) = 0 THEN 0
				ELSE (SUM(r.sbr) - SUM(r.sar))/SUM(r.sbr)
			END AS return_rate_product
FROM
(
	SELECT
		id_sales_order_item AS DC_id_sales_order_item,
		so.order_nr,
		so.created_at,
		soi.sku,
		soi.fk_sales_order,
		soi.name,
	1 AS sbr,
	0 AS sar,
	0 AS sbc,
	0 AS sac,
	SUBSTR(sku,0,INSTR(sku,'-')-1) AS productsku
  FROM dg_bob_sales_order_item soi
	LEFT JOIN dg_bob_sales_order so 
		ON soi.fk_sales_order = so.id_sales_order
WHERE 
	dwh_shipment_state NOT IN('item_invalid')
	AND so.order_nr IN(
'121029958718270',
'121023925931453',
'121023871134000',
'121023545719492',
'121022777969034',
'121022425203239',
'121022323489019',
'121021858621788',
'121021795920030',
'121021701065017',
'121021557652094',
'121021192385713',
'121020655560904',
'121020466516198',
'121020339097179',
'121020318697349',
'121024688469540',
'121031478017172',
'121030233917405',
'121029481038297',
'121020046702409',
'121016626686370',
'121016026744160',
'121027327859779',
'121025392340460',
'121022717412780',
'121021860219489',
'121025646203578',
'121025013570306',
'121024371791742',
'121024115176012',
'121023934210519',
'121022058562131',
'121021551083010',
'121020657694377',
'121020399820164',
'121018858420950',
'121017429012580',
'121016624062156',
'121016614397431',
'121016384594300',
'121016347095549',
'121016247697969',
'121023000567426',
'121020095644261',
'121018738244332',
'121023644163087',
'121023111775156',
'121020911539330',
'121019988522406',
'121016688508792',
'121030934220920',
'121026607159203',
'121025789385019',
'121024879829165',
'121022172831021',
'121020859305525',
'121020105278702',
'121020075677656',
'121017778341695',
'121017709560522',
'121017680555762',
'121017318543705',
'121017020204092',
'121017007193098',
'121016882631756',
'121016685245467',
'121016479381857',
'121016350482126',
'121016338247137',
'121016155825733',
'121022133612153',
'121020326903130',
'121016353924345',
'121022131167197',
'121030355738006',
'121018342399356',
'121017948449013',
'121017558271922',
'121017507556615',
'121030584730372',
'121030003571561',
'121029954404183',
'121029805095671',
'121029552444312',
'121028706446675',
'121028589757505',
'121028250368361',
'121028096910066',
'121026725037308',
'121025710401601',
'121025702785192',
'121025437955933',
'121024959264000',
'121024123974458',
'121024021645702',
'121023378369616',
'121023006817436',
'121022492799934',
'121021960078350',
'121021948515015',
'121020953652955',
'121020856952459',
'121020552491543',
'121020132789008',
'121019169716668',
'121018574714990',
'121018545870324',
'121018296388524',
'121018097557255',
'121017901216347',
'121017640479870',
'121017231533806',
'121017202078487',
'121017098349574',
'121017032062068',
'121016888605581',
'121016611704503',
'121016351623556',
'121016274772250',
'121016228886532',
'121016093580501',
'121025225816499',
'121023446507959',
'121022378825326',
'121021222009277',
'121030546657465',
'121029017342473',
'121019805756644',
'121018692965583',
'121030743191459',
'121023708893077',
'121020410837980',
'121016068136779',
'121025269723547',
'121024799202768',
'121024677949569',
'121023471441913',
'121023338725802',
'121023037729232',
'121021920331548',
'121021530418548',
'121020852897925',
'121020805651665',
'121020519842650',
'121017813647449',
'121016585198869',
'121016568314963',
'121016551646351',
'121016510420394',
'121016238240999',
'121029086661123',
'121027409444353',
'121021794549005',
'121019614776221',
'121018735028609',
'121018264897724',
'121017953133203',
'121017924724971',
'121017897430035',
'121029538498505',
'121028985065071',
'121028789527428',
'121028418137902',
'121027986749444',
'121026344905212',
'121025183682802',
'121025014413897',
'121024989780389',
'121023753003939',
'121023268256817',
'121023091875532',
'121022759122104',
'121022641363685',
'121022449902763',
'121022173067693',
'121021894751519',
'121021800042830',
'121021704958754',
'121021498484647',
'121021392406640',
'121021188503108',
'121021005838060',
'121020910555150',
'121020602980974',
'121020304756907',
'121020073513580',
'121019587640760',
'121019519282619',
'121018595882957',
'121018187580817',
'121018046524844',
'121017953847521',
'121017947714168',
'121017926150023',
'121017847623463',
'121017492961298',
'121017391696996',
'121017162542860',
'121017158195843',
'121016724777728',
'121016674772353',
'121016268268994',
'121030546656669',
'121022529598444',
'121021252432946',
'121020257662167',
'121017459453138',
'121017373093849',
'121016963009199',
'121016742477493',
'121026122498160',
'121024943226834',
'121024600336348',
'121021466657804',
'121030216053263',
'121027220749375',
'121026238697778',
'121023031370667',
'121022376823257',
'121020952970607',
'121018728389239',
'121018536100625',
'121018162532832',
'121017957012156',
'121017477533541',
'121028958714454',
'121025595569725',
'121025029294390',
'121024873510909',
'121023220824713',
'121022602967775',
'121019669071414',
'121019494695575',
'121019198843999',
'121018747043562',
'121018309584185',
'121018269749138',
'121017863941263',
'121017670853743',
'121017607309085',
'121017196762683',
'121017033944615',
'121016918302285',
'121016831966316',
'121016760676541',
'121016221489510',
'121016088417898',
'121031617106253',
'121030950344385',
'121030220179782',
'121029518548027',
'121029062161001',
'121028743412754',
'121028730345199',
'121028649693507',
'121028035676233',
'121027204825162',
'121026684212972',
'121026374321331',
'121026101775220',
'121026008137629',
'121025523520791',
'121025347675638',
'121025189937991',
'121024844026297',
'121024808451977',
'121023480227888',
'121023425382657',
'121022788084587',
'121022729629181',
'121022352634064',
'121021865908473',
'121021603682021',
'121021545709987',
'121021310348763',
'121020942592891',
'121020902854183',
'121020624382518',
'121020295438741',
'121019252718853',
'121018944715232',
'121018733117200',
'121018656325788',
'121018465464287',
'121017965496661',
'121017777609145',
'121017461994988',
'121017461345578',
'121017459467459',
'121017131181889',
'121017075040901',
'121016795402868',
'121016679020094',
'121016641989911',
'121016227889579',
'121016200877788',
'121016187353946',
'121016052572832',
'121030431851271',
'121030212675280',
'121028297284795',
'121028160872696',
'121027909602936',
'121027819661415',
'121027039354991',
'121024394259072',
'121023946585158',
'121020426913438',
'121019686084062',
'121017787461993',
'121016228760771'
)
	
UNION
SELECT
		id_sales_order_item AS DC_id_sales_order_item,
		so.order_nr,
		so.created_at,
		soi.sku,
		soi.fk_sales_order,
		soi.name,
	0 AS sbr,
	1 AS sar,
	0 AS sbc,
	0 AS sac,
	SUBSTR(sku,0,INSTR(sku,'-')-1) AS productsku
  FROM dg_bob_sales_order_item soi
	LEFT JOIN dg_bob_sales_order so 
		ON soi.fk_sales_order = so.id_sales_order
WHERE 
	dwh_shipment_state NOT IN ('item_invalid','item_canceled','item_rejected','item_returned','item_exchanged')
	AND so.order_nr IN(
'121029958718270',
'121023925931453',
'121023871134000',
'121023545719492',
'121022777969034',
'121022425203239',
'121022323489019',
'121021858621788',
'121021795920030',
'121021701065017',
'121021557652094',
'121021192385713',
'121020655560904',
'121020466516198',
'121020339097179',
'121020318697349',
'121024688469540',
'121031478017172',
'121030233917405',
'121029481038297',
'121020046702409',
'121016626686370',
'121016026744160',
'121027327859779',
'121025392340460',
'121022717412780',
'121021860219489',
'121025646203578',
'121025013570306',
'121024371791742',
'121024115176012',
'121023934210519',
'121022058562131',
'121021551083010',
'121020657694377',
'121020399820164',
'121018858420950',
'121017429012580',
'121016624062156',
'121016614397431',
'121016384594300',
'121016347095549',
'121016247697969',
'121023000567426',
'121020095644261',
'121018738244332',
'121023644163087',
'121023111775156',
'121020911539330',
'121019988522406',
'121016688508792',
'121030934220920',
'121026607159203',
'121025789385019',
'121024879829165',
'121022172831021',
'121020859305525',
'121020105278702',
'121020075677656',
'121017778341695',
'121017709560522',
'121017680555762',
'121017318543705',
'121017020204092',
'121017007193098',
'121016882631756',
'121016685245467',
'121016479381857',
'121016350482126',
'121016338247137',
'121016155825733',
'121022133612153',
'121020326903130',
'121016353924345',
'121022131167197',
'121030355738006',
'121018342399356',
'121017948449013',
'121017558271922',
'121017507556615',
'121030584730372',
'121030003571561',
'121029954404183',
'121029805095671',
'121029552444312',
'121028706446675',
'121028589757505',
'121028250368361',
'121028096910066',
'121026725037308',
'121025710401601',
'121025702785192',
'121025437955933',
'121024959264000',
'121024123974458',
'121024021645702',
'121023378369616',
'121023006817436',
'121022492799934',
'121021960078350',
'121021948515015',
'121020953652955',
'121020856952459',
'121020552491543',
'121020132789008',
'121019169716668',
'121018574714990',
'121018545870324',
'121018296388524',
'121018097557255',
'121017901216347',
'121017640479870',
'121017231533806',
'121017202078487',
'121017098349574',
'121017032062068',
'121016888605581',
'121016611704503',
'121016351623556',
'121016274772250',
'121016228886532',
'121016093580501',
'121025225816499',
'121023446507959',
'121022378825326',
'121021222009277',
'121030546657465',
'121029017342473',
'121019805756644',
'121018692965583',
'121030743191459',
'121023708893077',
'121020410837980',
'121016068136779',
'121025269723547',
'121024799202768',
'121024677949569',
'121023471441913',
'121023338725802',
'121023037729232',
'121021920331548',
'121021530418548',
'121020852897925',
'121020805651665',
'121020519842650',
'121017813647449',
'121016585198869',
'121016568314963',
'121016551646351',
'121016510420394',
'121016238240999',
'121029086661123',
'121027409444353',
'121021794549005',
'121019614776221',
'121018735028609',
'121018264897724',
'121017953133203',
'121017924724971',
'121017897430035',
'121029538498505',
'121028985065071',
'121028789527428',
'121028418137902',
'121027986749444',
'121026344905212',
'121025183682802',
'121025014413897',
'121024989780389',
'121023753003939',
'121023268256817',
'121023091875532',
'121022759122104',
'121022641363685',
'121022449902763',
'121022173067693',
'121021894751519',
'121021800042830',
'121021704958754',
'121021498484647',
'121021392406640',
'121021188503108',
'121021005838060',
'121020910555150',
'121020602980974',
'121020304756907',
'121020073513580',
'121019587640760',
'121019519282619',
'121018595882957',
'121018187580817',
'121018046524844',
'121017953847521',
'121017947714168',
'121017926150023',
'121017847623463',
'121017492961298',
'121017391696996',
'121017162542860',
'121017158195843',
'121016724777728',
'121016674772353',
'121016268268994',
'121030546656669',
'121022529598444',
'121021252432946',
'121020257662167',
'121017459453138',
'121017373093849',
'121016963009199',
'121016742477493',
'121026122498160',
'121024943226834',
'121024600336348',
'121021466657804',
'121030216053263',
'121027220749375',
'121026238697778',
'121023031370667',
'121022376823257',
'121020952970607',
'121018728389239',
'121018536100625',
'121018162532832',
'121017957012156',
'121017477533541',
'121028958714454',
'121025595569725',
'121025029294390',
'121024873510909',
'121023220824713',
'121022602967775',
'121019669071414',
'121019494695575',
'121019198843999',
'121018747043562',
'121018309584185',
'121018269749138',
'121017863941263',
'121017670853743',
'121017607309085',
'121017196762683',
'121017033944615',
'121016918302285',
'121016831966316',
'121016760676541',
'121016221489510',
'121016088417898',
'121031617106253',
'121030950344385',
'121030220179782',
'121029518548027',
'121029062161001',
'121028743412754',
'121028730345199',
'121028649693507',
'121028035676233',
'121027204825162',
'121026684212972',
'121026374321331',
'121026101775220',
'121026008137629',
'121025523520791',
'121025347675638',
'121025189937991',
'121024844026297',
'121024808451977',
'121023480227888',
'121023425382657',
'121022788084587',
'121022729629181',
'121022352634064',
'121021865908473',
'121021603682021',
'121021545709987',
'121021310348763',
'121020942592891',
'121020902854183',
'121020624382518',
'121020295438741',
'121019252718853',
'121018944715232',
'121018733117200',
'121018656325788',
'121018465464287',
'121017965496661',
'121017777609145',
'121017461994988',
'121017461345578',
'121017459467459',
'121017131181889',
'121017075040901',
'121016795402868',
'121016679020094',
'121016641989911',
'121016227889579',
'121016200877788',
'121016187353946',
'121016052572832',
'121030431851271',
'121030212675280',
'121028297284795',
'121028160872696',
'121027909602936',
'121027819661415',
'121027039354991',
'121024394259072',
'121023946585158',
'121020426913438',
'121019686084062',
'121017787461993',
'121016228760771'
)
	)r
GROUP BY r.productsku